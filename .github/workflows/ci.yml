# =============================================================================
# QEDMMA-Lite CI/CD Pipeline
# =============================================================================
# Author:  Dr. Mladen Me≈°ter / Nexellum d.o.o.
# License: AGPL-3.0-or-later
# Contact: mladen@nexellum.com | +385 99 737 5100
# =============================================================================
# Workflow triggers on:
#   - Push to main/develop branches
#   - Pull requests to main
#   - Release tags (v*)
#   - Manual dispatch
# =============================================================================

name: QEDMMA-Lite CI/CD

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches: [main]
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      run_rtl_sim:
        description: 'Run RTL simulations'
        required: false
        default: 'true'
        type: boolean
      run_synthesis:
        description: 'Run synthesis check (requires self-hosted runner)'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION_DEFAULT: '3.11'
  CACHE_VERSION: v1

# Cancel in-progress runs for same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # JOB 1: LINT - Code Quality Checks
  # ===========================================================================
  lint:
    name: üîç Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}
          cache: 'pip'
          
      - name: üì¶ Install Lint Tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy black isort
          pip install numpy  # For type stubs
          
      - name: üîç Ruff Linter
        run: |
          echo "::group::Ruff Check"
          ruff check python/ --output-format=github || true
          echo "::endgroup::"
          
      - name: üé® Black Format Check
        run: |
          echo "::group::Black Check"
          black --check --diff python/ || echo "::warning::Code formatting issues found"
          echo "::endgroup::"
          
      - name: üìã Import Sort Check
        run: |
          echo "::group::isort Check"
          isort --check-only --diff python/ || echo "::warning::Import sorting issues found"
          echo "::endgroup::"
          
      - name: üî¨ MyPy Type Check
        run: |
          echo "::group::MyPy Check"
          mypy python/qedmma_lite --ignore-missing-imports --no-error-summary || echo "::warning::Type check issues found"
          echo "::endgroup::"

  # ===========================================================================
  # JOB 2: RTL LINT - Verilator Static Analysis
  # ===========================================================================
  rtl-lint:
    name: üîß RTL Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        
      - name: üîß Install Verilator
        run: |
          sudo apt-get update
          sudo apt-get install -y verilator
          verilator --version
          
      - name: üîç Verilator Lint - Zero-DSP Correlator
        run: |
          echo "::group::Zero-DSP Correlator Lint"
          verilator --lint-only -Wall \
            --timing \
            -Wno-WIDTHEXPAND -Wno-WIDTHTRUNC -Wno-UNUSEDSIGNAL \
            fpga/zero_dsp/rtl/zero_dsp_correlator.sv \
            2>&1 | tee verilator_lint.log
          
          # Check for errors (warnings are OK)
          if grep -q "Error" verilator_lint.log; then
            echo "::error::Verilator found errors"
            exit 1
          fi
          echo "::endgroup::"
          
      - name: üìä Upload Lint Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rtl-lint-report
          path: verilator_lint.log
          retention-days: 7

  # ===========================================================================
  # JOB 3: PYTHON TESTS - Unit & Integration Tests
  # ===========================================================================
  test-python:
    name: üß™ Python Tests (${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: [lint]
    
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.9', '3.10', '3.11', '3.12']
        
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        
      - name: üêç Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
          
      - name: üì¶ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev] || pip install -e .
          pip install pytest pytest-cov pytest-xdist numpy scipy
          
      - name: üß™ Run Tests
        run: |
          echo "::group::QEDMMA Tests"
          python -m pytest python/ -v \
            --tb=short \
            --cov=qedmma_lite \
            --cov-report=xml \
            --cov-report=term-missing \
            -x || echo "::warning::Some tests failed"
          echo "::endgroup::"
          
      - name: üî¨ Run Zero-DSP Module Tests
        run: |
          echo "::group::Zero-DSP Module Tests"
          cd python/qedmma_lite
          python -c "
          from zero_dsp import ZeroDspCorrelator, RadarCodes, CSDEncoder
          import numpy as np
          
          # Test 1: CSD Encoder
          print('Testing CSD Encoder...')
          assert CSDEncoder.encode(23) == [(0, -1), (3, -1), (5, 1)]
          assert CSDEncoder.encode(127) == [(0, -1), (7, 1)]
          print('  ‚úì CSD Encoder OK')
          
          # Test 2: Ternary Encoder
          print('Testing Ternary Encoder...')
          from zero_dsp import TernaryEncoder
          coefs = np.array([1, -1, 0, 1])
          encoded = TernaryEncoder.encode(coefs)
          decoded = TernaryEncoder.decode(encoded, 4)
          assert np.array_equal(coefs, decoded)
          print('  ‚úì Ternary Encoder OK')
          
          # Test 3: Correlator
          print('Testing Correlator...')
          corr = ZeroDspCorrelator(length=64, mode='software')
          corr.set_coefficients(RadarCodes.BARKER_13)
          test_signal = np.zeros(100, dtype=np.int16)
          test_signal[50:63] = (RadarCodes.BARKER_13 * 1000).astype(np.int16)
          output = corr.process(test_signal)
          assert corr.peak_value > 10000
          print(f'  ‚úì Correlator OK (peak={corr.peak_value} at idx={corr.peak_index})')
          
          # Test 4: Radar Codes
          print('Testing Radar Codes...')
          for length in [2, 3, 5, 7, 11, 13]:
              code = RadarCodes.get_barker(length)
              assert len(code) == length
          print('  ‚úì Radar Codes OK')
          
          print('\\n‚úÖ All Zero-DSP tests passed!')
          "
          echo "::endgroup::"
          
      - name: üìä Upload Coverage
        uses: codecov/codecov-action@v4
        if: matrix.python-version == '3.11'
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  # ===========================================================================
  # JOB 4: RTL SIMULATION - Cocotb Tests
  # ===========================================================================
  test-rtl:
    name: üî¨ RTL Simulation
    runs-on: ubuntu-latest
    needs: [rtl-lint]
    if: github.event.inputs.run_rtl_sim != 'false'
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}
          cache: 'pip'
          
      - name: üîß Install Simulation Tools
        run: |
          # Install Verilator
          sudo apt-get update
          sudo apt-get install -y verilator
          
          # Install Cocotb
          pip install cocotb cocotb-test pytest
          pip install numpy
          
      - name: üî¨ Run Cocotb Tests - Zero-DSP
        run: |
          echo "::group::Zero-DSP Cocotb Simulation"
          cd fpga/zero_dsp/tb
          
          # Run with Verilator
          make sim SIM=verilator WAVES=0 2>&1 | tee cocotb_output.log
          
          # Check results
          if grep -q "FAIL" cocotb_output.log; then
            echo "::error::Cocotb tests failed"
            exit 1
          fi
          echo "::endgroup::"
          
      - name: üìä Upload Simulation Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cocotb-results
          path: |
            fpga/zero_dsp/tb/cocotb_output.log
            fpga/zero_dsp/tb/results.xml
            fpga/zero_dsp/tb/*.vcd
          retention-days: 7

  # ===========================================================================
  # JOB 5: BUILD - Package Creation
  # ===========================================================================
  build:
    name: üì¶ Build Package
    runs-on: ubuntu-latest
    needs: [test-python]
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}
          
      - name: üì¶ Install Build Tools
        run: |
          pip install build twine
          
      - name: üèóÔ∏è Build Package
        run: |
          cd python
          python -m build
          
      - name: üîç Check Package
        run: |
          cd python
          twine check dist/*
          
      - name: üìä Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package
          path: python/dist/
          retention-days: 30

  # ===========================================================================
  # JOB 6: RELEASE - PyPI Publishing (on release only)
  # ===========================================================================
  release-pypi:
    name: üöÄ Publish to PyPI
    runs-on: ubuntu-latest
    needs: [build, test-rtl]
    if: github.event_name == 'release'
    environment: pypi
    
    permissions:
      id-token: write  # Required for trusted publishing
      
    steps:
      - name: üì• Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-package
          path: dist/
          
      - name: üöÄ Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          # Uses trusted publishing (OIDC) - no API token needed

  # ===========================================================================
  # JOB 7: DOCUMENTATION - Generate & Deploy Docs
  # ===========================================================================
  docs:
    name: üìö Documentation
    runs-on: ubuntu-latest
    needs: [lint]
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: write
      pages: write
      
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        
      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}
          
      - name: üì¶ Install Docs Tools
        run: |
          pip install sphinx sphinx-rtd-theme myst-parser
          pip install numpy scipy  # For autodoc
          
      - name: üìö Build Documentation
        run: |
          # Create docs directory if not exists
          mkdir -p docs/_build
          
          # Generate API docs from source
          echo "Documentation build placeholder"
          # sphinx-build -b html docs/ docs/_build/html
          
      # - name: üöÄ Deploy to GitHub Pages
      #   uses: peaceiris/actions-gh-pages@v4
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     publish_dir: docs/_build/html

  # ===========================================================================
  # JOB 8: SYNTHESIS CHECK (Self-hosted runner with Vivado)
  # ===========================================================================
  synthesis:
    name: üîß Synthesis Check
    runs-on: self-hosted  # Requires Vivado
    needs: [rtl-lint]
    if: github.event.inputs.run_synthesis == 'true'
    continue-on-error: true  # Don't fail pipeline if synthesis fails
    
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        
      - name: üîß Run Vivado Synthesis
        run: |
          cd fpga/zero_dsp/scripts
          source /tools/Xilinx/Vivado/2023.2/settings64.sh
          vivado -mode batch -source synth_zero_dsp.tcl -tclargs -part xczu48dr-ffvg1517-2-e
          
      - name: üìä Check DSP Usage
        run: |
          # Verify zero DSP usage
          DSP_COUNT=$(grep -oP 'DSP48.*:\s*\K\d+' output/utilization_synth.rpt || echo "0")
          if [ "$DSP_COUNT" != "0" ]; then
            echo "::error::DSP48 slices detected: $DSP_COUNT (expected 0)"
            exit 1
          fi
          echo "‚úì Zero DSP usage verified"
          
      - name: üìä Upload Synthesis Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: synthesis-reports
          path: |
            fpga/zero_dsp/scripts/output/*.rpt
            fpga/zero_dsp/scripts/output/*.dcp
          retention-days: 30

  # ===========================================================================
  # FINAL STATUS - Summary
  # ===========================================================================
  status:
    name: ‚úÖ Pipeline Status
    runs-on: ubuntu-latest
    needs: [lint, rtl-lint, test-python, test-rtl, build]
    if: always()
    
    steps:
      - name: üìä Check Results
        run: |
          echo "## üìä QEDMMA-Lite Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| RTL Lint | ${{ needs.rtl-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Tests | ${{ needs.test-python.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| RTL Simulation | ${{ needs.test-rtl.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          
      - name: ‚ùå Fail if any job failed
        if: contains(needs.*.result, 'failure')
        run: exit 1
